name: _markdown-lint
on:
  workflow_call:
    inputs:
      config_repo: { type: string, default: kleffio/.github }
      config_ref:  { type: string, default: main }

permissions:
  contents: read

jobs:
  markdownlint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4

      - name: Checkout org config repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.config_repo }}
          ref: ${{ inputs.config_ref }}
          path: .github-org

      - name: Resolve markdownlint config
        id: cfg
        shell: bash
        run: |
          set -euo pipefail
          candidates=(
            ".github-org/configs/.markdownlint.jsonc"
            ".github-org/.github/configs/.markdownlint.jsonc"
          )
          for c in "${candidates[@]}"; do
            if [[ -f "$c" ]]; then
              echo "config_file=$c" >> "$GITHUB_OUTPUT"
              echo "Using config: $c"
              exit 0
            fi
          done
          echo "Searched for:"
          printf ' - %s\n' "${candidates[@]}"
          echo "‚ùå Could not find .markdownlint.jsonc in ${{ inputs.config_repo }}@${{ inputs.config_ref }}"
          exit 1

      - name: Run Markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v17
        with:
          config: ${{ steps.cfg.outputs.config_file }}
          globs: |
            **/*.md
            !.github-org/**
            !.git/**
