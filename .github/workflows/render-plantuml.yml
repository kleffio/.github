name: Render PlantUML + README -> bot branch

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "**/*.puml"
      - "**/*.plantuml"
      - ".github/workflows/render-plantuml.yml"

permissions:
  contents: write

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Install Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz
          dot -V

      - name: Download PlantUML
        run: |
          mkdir -p tools
          curl -L -o tools/plantuml.jar https://github.com/plantuml/plantuml/releases/latest/download/plantuml.jar

      - name: Render diagrams to SVG
        run: |
          rm -rf docs/diagrams
          mkdir -p docs/diagrams

          while IFS= read -r file; do
            echo "Rendering $file"
            java -DPLANTUML_DOT=/usr/bin/dot -jar tools/plantuml.jar -tsvg "$file" -o "$(pwd)/docs/diagrams" || {
              echo "FAILED: $file"
            }
          done < <(find . -type f \( -name "*.puml" -o -name "*.plantuml" \) | sort)

      - name: Generate docs/diagrams/README.md
        run: |
          mkdir -p docs/diagrams

          {
            echo "# Rendered PlantUML Diagrams"
            echo
            echo "> Auto-generated by GitHub Actions from \`.puml\` / \`.plantuml\` files."
            echo
            echo "## Index"
            echo
          } > docs/diagrams/README.md

          for f in docs/diagrams/*.svg; do
            [ -e "$f" ] || continue
            name="$(basename "$f")"
            base="${name%.svg}"
            anchor="$(echo "$base" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g; s/^-|-$//g')"
            echo "- [$base](#$anchor)" >> docs/diagrams/README.md
          done

          {
            echo
            echo "---"
            echo
            echo "## Diagrams"
            echo
          } >> docs/diagrams/README.md

          for f in docs/diagrams/*.svg; do
            [ -e "$f" ] || continue
            name="$(basename "$f")"
            base="${name%.svg}"
            echo "### $base" >> docs/diagrams/README.md
            echo >> docs/diagrams/README.md
            echo "![]($name)" >> docs/diagrams/README.md
            echo >> docs/diagrams/README.md
          done

      - name: Commit rendered diagrams to bot branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git checkout -B bot/render-plantuml
          git add docs/diagrams/**

          git commit -m "chore(diagrams): render PlantUML + README" || echo "No changes to commit"

      - name: Push bot branch
        run: |
          git push --force origin bot/render-plantuml

      - name: Links
        run: |
          echo "View rendered README:"
          echo "https://github.com/${{ github.repository }}/blob/bot/render-plantuml/docs/diagrams/README.md"
          echo "Open a PR to merge into main:"
          echo "https://github.com/${{ github.repository }}/pull/new/bot/render-plantuml"