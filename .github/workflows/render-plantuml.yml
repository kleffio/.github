name: Render PlantUML + README -> PR

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "**/*.puml"
      - "**/*.plantuml"
      - ".github/workflows/render-plantuml.yml"

permissions:
  contents: write
  pull-requests: write

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz
          dot -V

      - name: Download PlantUML
        run: |
          mkdir -p tools
          curl -L -o tools/plantuml.jar https://github.com/plantuml/plantuml/releases/latest/download/plantuml.jar

      - name: Render diagrams to SVG
        run: |
          rm -rf docs/diagrams
          mkdir -p docs/diagrams

          while IFS= read -r file; do
            echo "Rendering $file"
            # PlantUML outputs to the directory passed by -o (it uses the base file name)
            java -DPLANTUML_DOT=/usr/bin/dot -jar tools/plantuml.jar -tsvg "$file" -o "$(pwd)/docs/diagrams" || {
              echo "FAILED: $file"
            }
          done < <(find . -type f \( -name "*.puml" -o -name "*.plantuml" \) | sort)

      - name: Generate docs/diagrams/README.md
        run: |
          mkdir -p docs/diagrams

          {
            echo "# Rendered PlantUML Diagrams"
            echo
            echo "> Auto-generated by GitHub Actions from \`.puml\` / \`.plantuml\` files."
            echo
            echo "## Index"
            echo
          } > docs/diagrams/README.md

          # Index list
          for f in docs/diagrams/*.svg; do
            [ -e "$f" ] || continue
            name="$(basename "$f")"
            base="${name%.svg}"
            anchor="$(echo "$base" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g; s/^-|-$//g')"
            echo "- [$base](#$anchor)" >> docs/diagrams/README.md
          done

          {
            echo
            echo "---"
            echo
            echo "## Diagrams"
            echo
          } >> docs/diagrams/README.md

          # Embedded diagrams
          for f in docs/diagrams/*.svg; do
            [ -e "$f" ] || continue
            name="$(basename "$f")"
            base="${name%.svg}"
            echo "### $base" >> docs/diagrams/README.md
            echo >> docs/diagrams/README.md
            echo "![]($name)" >> docs/diagrams/README.md
            echo >> docs/diagrams/README.md
          done

      - name: Create/Update PR with rendered diagrams + README
        uses: peter-evans/create-pull-request@v7
        with:
          branch: bot/render-plantuml
          title: "chore(diagrams): render PlantUML + README"
          commit-message: "chore(diagrams): render PlantUML + README"
          body: |
            Auto-generated rendered PlantUML diagrams in `docs/diagrams/` plus an embedded `README.md` index.
          labels: diagrams
          add-paths: |
            docs/diagrams/**